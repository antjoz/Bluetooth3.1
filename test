using System;
using System.IO;
using System.Threading;
using System.Windows.Forms;
using InTheHand.Net;
using InTheHand.Net.Bluetooth;
using InTheHand.Net.Sockets;
using InTheHand.Net.Obex;

namespace Bluetooth3._1
{
    public partial class Form1 : Form
    {
        private BluetoothClient bluetoothClient;
        private BluetoothDeviceInfo[] devices;

        // OBEX Listener
        private Thread obexListenerThread;
        private bool obexListening = true;

        public Form1()
        {
            InitializeComponent();

            bluetoothClient = new BluetoothClient();
            lblStatus.Text = "Status: Bluetooth uruchomiony";

            StartObexListener();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
        }

        // =========================
        // WYSZUKIWANIE URZĄDZEŃ
        // =========================
        private void btnSearch_Click(object sender, EventArgs e)
        {
            listDevices.Items.Clear();
            lblStatus.Text = "Status: wyszukiwanie urządzeń...";

            try
            {
                devices = bluetoothClient.DiscoverDevices();

                foreach (BluetoothDeviceInfo device in devices)
                {
                    listDevices.Items.Add(device.DeviceName);
                }

                lblStatus.Text = $"Status: znaleziono {devices.Length} urządzeń";
            }
            catch (Exception ex)
            {
                MessageBox.Show("Błąd wyszukiwania: " + ex.Message);
                lblStatus.Text = "Status: błąd";
            }
        }

        // =========================
        // PAROWANIE
        // =========================
        private void btnConnect_Click(object sender, EventArgs e)
        {
            if (listDevices.SelectedIndex == -1)
            {
                MessageBox.Show("Wybierz urządzenie!");
                return;
            }

            BluetoothDeviceInfo device = devices[listDevices.SelectedIndex];

            try
            {
                bool paired = BluetoothSecurity.PairRequest(
                    device.DeviceAddress,
                    null // system zapyta o PIN
                );

                lblStatus.Text = paired
                    ? $"Status: sparowano z {device.DeviceName}"
                    : "Status: parowanie nieudane";
            }
            catch (Exception ex)
            {
                MessageBox.Show("Błąd parowania: " + ex.Message);
            }
        }

        // =========================
        // WYSYŁANIE PLIKU (OBEX)
        // =========================
        private void btnSendFile_Click(object sender, EventArgs e)
        {
            if (listDevices.SelectedIndex == -1)
            {
                MessageBox.Show("Wybierz urządzenie!");
                return;
            }

            OpenFileDialog ofd = new OpenFileDialog
            {
                Title = "Wybierz plik do wysłania"
            };

            if (ofd.ShowDialog() != DialogResult.OK)
                return;

            BluetoothDeviceInfo device = devices[listDevices.SelectedIndex];

            try
            {
                Uri uri = new Uri(
                    "obex://" +
                    device.DeviceAddress.ToString().Replace(":", "") +
                    "/" +
                    Path.GetFileName(ofd.FileName)
                );

                ObexWebRequest request = new ObexWebRequest(uri);
                request.ReadFile(ofd.FileName);

                using (ObexWebResponse response =
                       (ObexWebResponse)request.GetResponse())
                {
                }

                lblStatus.Text = "Status: plik wysłany poprawnie";
            }
            catch (Exception ex)
            {
                MessageBox.Show("Błąd wysyłania: " + ex.Message);
                lblStatus.Text = "Status: błąd wysyłania";
            }
        }

        // =========================
        // ODBIERANIE PLIKÓW (OBEX)
        // =========================
        private void StartObexListener()
        {
            obexListenerThread = new Thread(ObexListenerWorker)
            {
                IsBackground = true
            };
            obexListenerThread.Start();
        }

        private void ObexListenerWorker()
        {
            ObexListener listener = null;

            try
            {
                listener = new ObexListener(ObexTransport.Bluetooth);
                listener.Start();

                while (obexListening)
                {
                    ObexListenerContext context = listener.GetContext();

                    if (context == null || context.Request == null)
                        continue;

                    ObexListenerRequest request = context.Request;

                    string rawUrl = request.RawUrl;
                    if (string.IsNullOrEmpty(rawUrl))
                        continue;

                    string fileName = rawUrl.TrimStart('/');

                    string folder = Path.Combine(
                        Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments),
                        "Odebrane"
                    );

                    Directory.CreateDirectory(folder);

                    string filePath = Path.Combine(folder, fileName);

                    // ZAPIS PLIKU
                    request.WriteFile(filePath);

                    Invoke(new Action(() =>
                    {
                        lblStatus.Text =
                            "Status: odebrano plik → " +
                            Path.GetFileName(filePath);
                    }));
                }
            }
            catch (Exception ex)
            {
                Invoke(new Action(() =>
                {
                    MessageBox.Show("Błąd odbierania: " + ex.Message);
                }));
            }
            finally
            {
                listener?.Stop();
            }
        }

        // =========================
        // ZAMYKANIE APLIKACJI
        // =========================
        private void Form1_FormClosing(object sender, FormClosingEventArgs e)
        {
            obexListening = false;

            if (obexListenerThread != null && obexListenerThread.IsAlive)
                obexListenerThread.Abort();

            bluetoothClient?.Dispose();
        }
    }
}
